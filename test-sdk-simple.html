<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Simple SDK SunuID</title>
    
    <!-- Socket.IO pour WebSocket -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js?v=1"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .qr-display {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qr-display img {
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .config-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
        }
        .status-ok { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .status-info { background: #17a2b8; color: white; }
    </style>
</head>
<body>
    <h1>üß™ Test Simple SDK SunuID</h1>
    <p>Test basique du SDK JavaScript SunuID</p>

    <div class="container">
        <h2>üìä √âtat du SDK</h2>
        <div id="sdkStatus">
            <span class="status-indicator status-info">V√©rification...</span>
        </div>
    </div>

    <div class="container">
        <h2>‚öôÔ∏è Configuration</h2>
        <div class="test-section">
            <h3>Param√®tres de Test</h3>
            <div>
                <label>Mode:</label>
                <select id="modeSelect" class="config-input">
                    <option value="classic">Mode Classique</option>
                    <option value="secure">Mode S√©curis√©</option>
                    <option value="kyc">Mode KYC</option>
                </select>
            </div>
            <div>
                <label>Type de Service:</label>
                <select id="typeSelect" class="config-input">
                    <option value="1">1 - KYC (V√©rification d'identit√©)</option>
                    <option value="2" selected>2 - AUTH (Authentification)</option>
                    <option value="3">3 - SIGNATURE (Signature √©lectronique)</option>
                </select>
            </div>
            <div>
                <label>Service ID:</label>
                <input type="text" id="serviceId" class="config-input" value="" placeholder="R√©cup√©r√© depuis l'API" readonly>
                <small style="color: #666;">Le Service ID sera r√©cup√©r√© automatiquement depuis l'API</small>
            </div>
            <div>
                <label>Client ID (pour modes s√©curis√©s):</label>
                <input type="text" id="clientId" class="config-input" value="1754166754_221A57B46843D755" placeholder="Client ID">
            </div>
            <div>
                <label>Secret ID (pour modes s√©curis√©s):</label>
                <input type="text" id="secretId" class="config-input" value="56d40fe70507228b27f2640ae65894177c2fedbf246e2b30978fde1fc43953c5" placeholder="Secret ID">
            </div>
            <div>
                <label>Rafra√Æchissement automatique:</label>
                <select id="autoRefreshSelect" class="config-input">
                    <option value="false" selected>D√©sactiv√© (recommand√©)</option>
                    <option value="true">Activ√© (30 secondes)</option>
                </select>
                <small style="color: #666;">Le rafra√Æchissement automatique peut causer des appels r√©p√©titifs √† l'API</small>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîß Tests SDK</h2>
        
        <div class="test-section">
            <h3>Test 1: Initialisation du SDK</h3>
            <button onclick="testInit()" id="initBtn">Initialiser SDK</button>
            <div id="initResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: G√©n√©ration QR Code</h3>
            <button onclick="testGenerateQR()" id="qrBtn" disabled>G√©n√©rer QR Code</button>
            <!-- Conteneur unique pour le QR code -->
            <div id="sunuid-qr-container" class="qr-display">
                <div class="text-muted">
                    <p>Initialisez d'abord le SDK</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Test 3: R√©cup√©ration QR Code</h3>
            <button onclick="testGetQR()" id="getQrBtn" disabled>R√©cup√©rer QR Code</button>
            <div id="getQrResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 4: √âtat du SDK</h3>
            <button onclick="testStatus()" id="statusBtn" disabled>V√©rifier √âtat</button>
            <div id="statusResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 5: Contr√¥le du Rafra√Æchissement</h3>
            <button onclick="stopAutoRefresh()" id="stopRefreshBtn" disabled>Arr√™ter Rafra√Æchissement</button>
            <button onclick="startAutoRefresh()" id="startRefreshBtn" disabled>D√©marrer Rafra√Æchissement</button>
            <div id="refreshResult"></div>
        </div>

        <div class="test-section">
            <h3>Test 5: Test Complet</h3>
            <button onclick="runCompleteTest()" id="completeBtn">Test Complet</button>
            <div id="completeResult"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìù Logs</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Effacer les Logs</button>
    </div>

    <!-- Chargement du SDK -->
    <script src="dist/sunuid-sdk.min.js?v=1"></script>
    
    <script>
        // V√©rifier que Socket.IO est charg√©
        if (typeof io === 'undefined') {
            console.error('‚ùå Socket.IO non charg√© !');
            document.body.innerHTML = '<div style="color: red; padding: 20px;">‚ùå Erreur: Socket.IO non charg√©. V√©rifiez votre connexion internet.</div>';
        } else {
            console.log('‚úÖ Socket.IO charg√© avec succ√®s');
        }
        
        let sunuid = null;
        let testResults = {
            total: 0,
            success: 0,
            errors: 0
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page de test simple SDK SunuID charg√©e');
            checkSDKAvailability();
            
            // Ajouter un listener pour le changement de type
            document.getElementById('typeSelect').addEventListener('change', function() {
                const type = parseInt(this.value);
                const typeNames = {
                    1: 'KYC (V√©rification d\'identit√©)',
                    2: 'AUTH (Authentification)',
                    3: 'SIGNATURE (Signature √©lectronique)'
                };
                log(`üîÑ Type de service chang√©: ${type} - ${typeNames[type]}`, 'info');
            });
            
            // Ajouter un listener pour le changement de rafra√Æchissement automatique
            document.getElementById('autoRefreshSelect').addEventListener('change', function() {
                const autoRefresh = this.value === 'true';
                log(`üîÑ Rafra√Æchissement automatique: ${autoRefresh ? 'Activ√©' : 'D√©sactiv√©'}`, 'info');
            });
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateSDKStatus(status, message) {
            const statusDiv = document.getElementById('sdkStatus');
            statusDiv.innerHTML = `<span class="status-indicator status-${status}">${message}</span>`;
        }

        function checkSDKAvailability() {
            if (typeof SunuID !== 'undefined') {
                updateSDKStatus('ok', 'SDK Disponible');
                log('‚úÖ SDK SunuID d√©tect√© et disponible', 'success');
            } else {
                updateSDKStatus('error', 'SDK Non Disponible');
                log('‚ùå SDK SunuID non trouv√©', 'error');
            }
        }

        function getConfig() {
            const mode = document.getElementById('modeSelect').value;
            const type = parseInt(document.getElementById('typeSelect').value);
            const clientId = document.getElementById('clientId').value;
            const secretId = document.getElementById('secretId').value;
            const autoRefresh = document.getElementById('autoRefreshSelect').value === 'true';

            let config = {
                mode: mode,
                type: type,
                clientId: clientId,
                secretId: secretId,
                autoRefresh: autoRefresh
            };

            return config;
        }

        async function testInit() {
            // √âviter l'initialisation multiple
            if (sunuid && sunuid.isInitialized) {
                log('‚ö†Ô∏è SDK d√©j√† initialis√©, pas besoin de r√©initialiser', 'info');
                return;
            }
            
            testResults.total++;
            log('üß™ Test: Initialisation SDK');
            
            try {
                const config = getConfig();
                log(`üìã Configuration: ${JSON.stringify(config)}`);
                
                sunuid = new SunuID(config);
                
                // Intercepter la r√©ponse de l'API d'initialisation
                const originalMakeRequest = sunuid.makeRequest;
                let apiResponse = null;
                
                sunuid.makeRequest = async function(endpoint, data) {
                    const response = await originalMakeRequest.call(this, endpoint, data);
                    
                    // Capturer la r√©ponse de l'endpoint /debug
                    if (endpoint === '/debug') {
                        apiResponse = response;
                    }
                    
                    return response;
                };
                
                await sunuid.init();
                
                // Restaurer la m√©thode originale
                sunuid.makeRequest = originalMakeRequest;
                
                // Afficher la r√©ponse de l'API
                if (apiResponse) {
                    log('üìã R√©ponse API d\'initialisation:', 'info');
                    log(JSON.stringify(apiResponse, null, 2), 'info');
                    
                                    // Afficher les informations importantes
                if (apiResponse.authentication && apiResponse.authentication.auth_test) {
                    const authTest = apiResponse.authentication.auth_test;
                    const type = parseInt(document.getElementById('typeSelect').value);
                    const typeNames = {
                        1: 'KYC',
                        2: 'AUTH',
                        3: 'SIGNATURE'
                    };
                    
                    log(`üéØ Type de service: ${type} - ${typeNames[type]}`, 'info');
                    log(`üÜî Partner ID: ${authTest.partner_id}`, 'info');
                    log(`üë§ Client ID: ${authTest.client_id}`, 'info');
                    log(`üîê Secret ID: ${authTest.secret_id ? '***' + authTest.secret_id.slice(-4) : 'null'}`, 'info');
                    
                    // Afficher le Service ID r√©cup√©r√©
                    const serviceId = apiResponse.service_id || authTest.partner_id;
                    log(`üÜî Service ID: ${serviceId}`, 'info');
                    
                    // Mettre √† jour l'interface avec le Service ID r√©cup√©r√©
                    document.getElementById('serviceId').value = serviceId;
                }
                }
                
                testResults.success++;
                updateSDKStatus('ok', 'SDK Initialis√©');
                
                document.getElementById('initResult').innerHTML = `
                    <div class="success">
                        <p><strong>‚úÖ SDK initialis√© avec succ√®s!</strong></p>
                        <p>Mode: ${config.mode}</p>
                        <p>Service ID: ${config.serviceId}</p>
                    </div>
                `;
                
                // Activer les boutons
                document.getElementById('qrBtn').disabled = false;
                document.getElementById('getQrBtn').disabled = false;
                document.getElementById('statusBtn').disabled = false;
                document.getElementById('stopRefreshBtn').disabled = false;
                document.getElementById('startRefreshBtn').disabled = false;
                
                // D√©sactiver le bouton d'initialisation
                document.getElementById('initBtn').disabled = true;
                document.getElementById('initBtn').textContent = 'SDK Initialis√©';
                
                log('‚úÖ SDK initialis√© avec succ√®s', 'success');
                
            } catch (error) {
                testResults.errors++;
                updateSDKStatus('error', 'Erreur Initialisation');
                
                document.getElementById('initResult').innerHTML = `
                    <div class="error">
                        <p><strong>‚ùå Erreur d'initialisation!</strong></p>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Erreur d'initialisation: ${error.message}`, 'error');
            }
        }

        async function testGenerateQR() {
            testResults.total++;
            log('üß™ Test: G√©n√©ration QR Code');
            
            // Pr√©parer le conteneur
            const qrContainer = document.getElementById('sunuid-qr-container');
            qrContainer.innerHTML = '<p>G√©n√©ration QR Code en cours...</p>';
            
            try {
                const qrResult = await sunuid.generateQR('sunuid-qr-container');
                
                testResults.success++;
                
                // Le SDK affiche d√©j√† le QR code dans le conteneur
                log('‚úÖ QR Code g√©n√©r√© avec succ√®s', 'success');
                
            } catch (error) {
                testResults.errors++;
                
                qrContainer.innerHTML = `
                    <div class="error">
                        <p><strong>‚ùå Erreur de g√©n√©ration QR!</strong></p>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Erreur de g√©n√©ration QR: ${error.message}`, 'error');
            }
        }

        async function testGetQR() {
            testResults.total++;
            log('üß™ Test: R√©cup√©ration QR Code');
            
            try {
                const qrUrl = sunuid.getQRCode();
                
                testResults.success++;
                
                document.getElementById('getQrResult').innerHTML = `
                    <div class="success">
                        <p><strong>‚úÖ QR Code r√©cup√©r√©!</strong></p>
                        <p>URL: ${qrUrl || 'Aucun QR code disponible'}</p>
                        ${qrUrl ? `<img src="${qrUrl}" alt="QR Code" style="max-width: 200px;" />` : ''}
                    </div>
                `;
                
                log(`‚úÖ QR Code r√©cup√©r√©: ${qrUrl}`, 'success');
                
            } catch (error) {
                testResults.errors++;
                
                document.getElementById('getQrResult').innerHTML = `
                    <div class="error">
                        <p><strong>‚ùå Erreur de r√©cup√©ration QR!</strong></p>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Erreur de r√©cup√©ration QR: ${error.message}`, 'error');
            }
        }

        async function testStatus() {
            testResults.total++;
            log('üß™ Test: √âtat du SDK');
            
            try {
                const status = {
                    initialized: sunuid.isInitialized ? 'Oui' : 'Non',
                    mode: sunuid.mode || 'Non d√©fini',
                    serviceId: sunuid.serviceId || 'Non d√©fini',
                    currentQRUrl: sunuid.currentQRUrl || 'Aucun',
                    websocketStatus: sunuid.websocketStatus || 'Non initialis√©'
                };
                
                testResults.success++;
                
                document.getElementById('statusResult').innerHTML = `
                    <div class="success">
                        <p><strong>‚úÖ √âtat du SDK:</strong></p>
                        <ul>
                            <li>Initialis√©: ${status.initialized}</li>
                            <li>Mode: ${status.mode}</li>
                            <li>Service ID: ${status.serviceId}</li>
                            <li>QR URL actuel: ${status.currentQRUrl}</li>
                            <li>WebSocket: ${status.websocketStatus}</li>
                        </ul>
                    </div>
                `;
                
                log('‚úÖ √âtat du SDK r√©cup√©r√©', 'success');
                
            } catch (error) {
                testResults.errors++;
                
                document.getElementById('statusResult').innerHTML = `
                    <div class="error">
                        <p><strong>‚ùå Erreur de r√©cup√©ration d'√©tat!</strong></p>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
                
                log(`‚ùå Erreur de r√©cup√©ration d'√©tat: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            log('üöÄ D√©marrage du test complet');
            
            // Test 1: Initialisation
            await testInit();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Test 2: G√©n√©ration QR (si SDK initialis√©)
            if (sunuid) {
                await testGenerateQR();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Test 3: R√©cup√©ration QR
                await testGetQR();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Test 4: √âtat SDK
                await testStatus();
            }
            
            log('üèÅ Test complet termin√©');
            
            document.getElementById('completeResult').innerHTML = `
                <div class="success">
                    <p><strong>‚úÖ Test complet termin√©!</strong></p>
                    <p>Total: ${testResults.total} tests</p>
                    <p>Succ√®s: ${testResults.success}</p>
                    <p>Erreurs: ${testResults.errors}</p>
                </div>
            `;
        }

        function stopAutoRefresh() {
            if (sunuid && sunuid.stopAutoRefresh) {
                sunuid.stopAutoRefresh();
                log('üîÑ Rafra√Æchissement automatique arr√™t√© manuellement', 'success');
                document.getElementById('refreshResult').innerHTML = `
                    <div class="success">
                        <p><strong>‚úÖ Rafra√Æchissement automatique arr√™t√©!</strong></p>
                    </div>
                `;
            } else {
                log('‚ùå SDK non initialis√© ou m√©thode non disponible', 'error');
            }
        }

        function startAutoRefresh() {
            if (sunuid && sunuid.startAutoRefresh) {
                sunuid.startAutoRefresh('sunuid-qr-container', sunuid.config.type, {});
                log('üîÑ Rafra√Æchissement automatique d√©marr√© manuellement', 'success');
                document.getElementById('refreshResult').innerHTML = `
                    <div class="success">
                        <p><strong>‚úÖ Rafra√Æchissement automatique d√©marr√©!</strong></p>
                        <p>Intervalle: ${sunuid.config.refreshInterval}ms</p>
                    </div>
                `;
            } else {
                log('‚ùå SDK non initialis√© ou m√©thode non disponible', 'error');
            }
        }
    </script>
</body>
</html> 